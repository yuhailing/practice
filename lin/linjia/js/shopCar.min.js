$(document).ready(function() {
    shopTitle($(".bot-a-fou"));
    shopTitle($(".daily-shopcar-img"))
});
function shopTitle(obj) {
    touch.on(obj, "tap", function() {
        if (localStorage.getItem("userId")) {
            checkCar()
        } else {
            messageAlert("您还没有登录");
            window.location.href = "login.html"
        }
    })
}
function removeInfor() {
    semoveItem("orderCou1", "orderCou1");
    semoveItem("orderCou2", "orderCou2");
    semoveItem("orderLoc", "orderLoc");
    semoveItem("odpl1", "odpl1");
    semoveItem("odpl2", "odpl2");
    semoveItem("goods-date", "goods-date");
    semoveItem(".goods-date", ".goods-date");
    semoveItem("goodsSend_one_para", "goodsSend_one_para");
    semoveItem(".goods-day", ".goods-day");
    semoveItem("goods-daye", "goods-daye");
    semoveItem("goodsSend_two_para", "goodsSend_two_para");
    semoveItem("orderYear", "orderYear");
    semoveItem("btn", "btn");
    semoveItem("orderCouArr2", "orderCouArr2");
    semoveItem("orderCouArr1", "orderCouArr1");
    semoveItem("orderCouArr", "orderCouArr")
}
function hidSth(_obj1) {
    touch.on($(".car_cont"), "tap", function() {
        sAjax("shoppingcar/selectCarAllProduct", "get", {
            mallCode: sessionStorage.getItem("mall"),
            userId: localStorage.getItem("userId")
        }, function(data) {
            if (data["status"] == "ok") {
                if (Number(data["resultData"]["totalProductNum"]) > 0) {
                    $("#tip").css({
                        "display": "block"
                    });
                    $("#tip").text(data["resultData"]["totalProductNum"]);
                    $(".daily-shopcar-num").text("您的购物车已有" + data["resultData"]["totalProductNum"] + "件商品")
                }
                if (Number(data["resultData"]["totalProductPrice"]) < 25) {
                    $(".daily-shopcar-warn p").text("差￥" + Number(25 - Number(data["resultData"]["totalProductPrice"])) + "结算").css({
                        "background": "#dedede",
                        "color": "#323232"
                    });
                    $(".daily-shopcar-warn").attr({
                        "ck": 0
                    })
                } else {
                    $(".daily-shopcar-warn p").text("去结算").css({
                        "background": "#ef8200",
                        "color": "#f7f7f7"
                    });
                    $(".daily-shopcar-warn").attr({
                        "ck": 1
                    })
                }
                var _h = $(".shopCar").height();
                var _timer = setInterval(function() {
                    _h -= 4;
                    $(".shopCar").height((_h));
                    if (_h < 0) {
                        clearInterval(_timer);
                        _h = 0;
                        $(".shopCar").height((_h));
                        $(".shopCar").css({
                            "display": "none"
                        })
                    }
                }, 5);
                $(".car_cont").addClass("hid");
                setTimeout(function() {
                    $(".car_conts").addClass("hid")
                }, 300);
                if (_obj1) {
                    _obj1.removeClass("hid")
                }
            }
        })
    })
}
function checkCar(_obj) {
    if (localStorage.getItem("userId")) {
        sAjax("shoppingcar/selectCarAllProduct", "get", {
            mallCode: sessionStorage.getItem("mall"),
            userId: localStorage.getItem("userId")
        }, function(data) {
            if (data["status"] == "ok") {
                if (data["resultData"]["shoppingCarList"].length) {
                    $(".car_conts").removeClass("hid");
                    $(".car_cont").removeClass("hid");
                    $(".car_list").html($(".car_goods").eq(0));
                    var _h = 0;
                    for (var i = 0, _len = data["resultData"]["shoppingCarList"].length; i < _len; i += 1) {
                        var _temp = $(".car_goods").eq(0).clone().removeClass("hid");
                        _temp.attr({
                            "jk": data["resultData"]["shoppingCarList"][i]["pCode"],
                            "pid": data["resultData"]["shoppingCarList"][i]["id"]
                        });
                        _temp.find("article").text(data["resultData"]["shoppingCarList"][i]["pName"]);
                        _temp.find(".car-item-num").text(data["resultData"]["shoppingCarList"][i]["quantity"]);
                        _temp.find(".car-item-num").attr({
                            "id": data["resultData"]["shoppingCarList"][i]["id"]
                        });
                        _temp.find(".car-item-num").attr({
                            "miaoshaoActiveProductId": data["resultData"]["shoppingCarList"][i]["miaoshaoActiveProductId"]
                        });
                        _temp.find(".car-item-num").attr({
                            "pSendType": data["resultData"]["shoppingCarList"][i]["pSendType"]
                        });
                        _temp.find(".car-item-num").attr({
                            "pCode": data["resultData"]["shoppingCarList"][i]["pCode"]
                        });
                        _temp.find(".car-item-num").attr({
                            "itemStatus": data["resultData"]["shoppingCarList"][i]["itemStatus"]
                        });
                        _temp.find(".car-item-num").attr({
                            "creDate": data["resultData"]["shoppingCarList"][i]["creDate"]
                        });
                        _temp.find(".car-item-num").attr({
                            "miaoshaoQty": data["resultData"]["shoppingCarList"][i]["miaoshaoQty"]
                        });
                        _temp.find(".car-item-num").attr({
                            "productId": data["resultData"]["shoppingCarList"][i]["productId"]
                        });
                        if (data["resultData"]["shoppingCarList"][i]["itemStatus"] == 1) {
                            _temp.css({
                                "background": "#ebebeb"
                            });
                            _temp.find(".car-item-min img").attr({
                                "src": "../img/icon/minTo1.png"
                            });
                            _temp.find(".car-item-min").attr({
                                "cl": "0"
                            });
                            _temp.find(".car-item-add img").attr({
                                "src": "../img/icon/addTo1.png"
                            });
                            _temp.find(".car-item-add").attr({
                                "cl": "0"
                            });
                            _temp.find(".car_it").remove();
                            _temp.find(".car-item-prc").css({
                                "fontSize": "1.2rem",
                                "width": "40%"
                            }).text("补货中")
                        } else {
                            _temp.css({
                                "background": "#fff"
                            });
                            _temp.find(".car-item-min").attr({
                                "cl": "1"
                            });
                            _temp.find(".car-item-add").attr({
                                "cl": "1"
                            });
                            _temp.find(".car-item-prc").text(Number(data["resultData"]["shoppingCarList"][i]["itemPrice"]).toFixed(2))
                        }
                        if (Number(data["resultData"]["shoppingCarList"][i]["tradeActivityId"]) > 0) {
                            _temp.attr({
                                "actype": "" + 4
                            });
                            var _exImg = $("<img>");
                            _exImg.addClass("exImg");
                            _exImg.attr({
                                "src": "../img/icon/exchange.jpg"
                            });
                            _exImg.prependTo(_temp.find(".car-item "));
                            var _tempp = $(".ex_goods_link").eq(0).clone().removeClass("hid");
                            _tempp.attr({
                                "act": data["resultData"]["shoppingCarList"][i]["tradeActivityId"],
                                "pId": data["resultData"]["shoppingCarList"][i]["id"]
                            });
                            _tempp.find(".color-brown").text(data["resultData"]["shoppingCarList"][i]["tradeActivityName"]);
                            _tempp.prependTo(_temp);
                            _h += 40;
                            if (data["resultData"]["shoppingCarList"][i]["activityTradeProductList"]) {
                                var exArr = []
                                  , exJson = {};
                                for (var j = 0, _lenj = data["resultData"]["shoppingCarList"][i]["activityTradeProductList"].length; j < _lenj; j += 1) {
                                    var _tempj = $(".ex_goods").eq(0).clone().removeClass("hid");
                                    _tempj.attr({
                                        "trid": data["resultData"]["shoppingCarList"][i]["activityTradeProductList"][j]["id"]
                                    });
                                    _tempj.find(".ex_goods_name").text(data["resultData"]["shoppingCarList"][i]["activityTradeProductList"][j]["p_name"]);
                                    _tempj.find(".ex_goods_price").text("￥" + Number(data["resultData"]["shoppingCarList"][i]["activityTradeProductList"][j]["p_trade_price"]).toFixed(2));
                                    _tempj.appendTo(_temp);
                                    _h += 32;
                                    exArr.push(data["resultData"]["shoppingCarList"][i]["activityTradeProductList"][j]["id"])
                                }
                                exJson["" + data["resultData"]["shoppingCarList"][i]["id"]] = exArr
                            }
                            sessionStorage.setItem("tar", exJson)
                        }
                        _temp.appendTo($(".car_list"));
                        _h += 47
                    }
                    $(".ex_goods_link").each(function(m) {
                        touch.on($(".ex_goods_link").eq(m), "tap", function() {
                            var _ex = "";
                            $(".ex_goods_link").eq(m).siblings(".ex_goods").each(function(n) {
                                _ex += $(".ex_goods_link").eq(m).siblings(".ex_goods").eq(n).attr("trid") + "$"
                            });
                            sessionStorage.setItem("ex", _ex);
                            window.location.href = "exchange.html?act=" + $(".ex_goods_link").eq(m).attr("act") + "?pId=" + $(".ex_goods_link").eq(m).attr("pId")
                        })
                    });
                    if (_h < 310) {
                        $(".car-inr").height(_h)
                    } else {
                        $(".car-inr").height(310)
                    }
                    $(".daily-bot-price").text("￥" + Number(data["resultData"]["totalProductPrice"]).toFixed(2));
                    if (data["resultData"]["totalProductNum"] > 0) {
                        $("#tp").css({
                            "display": "block"
                        }).text(data["resultData"]["totalProductNum"]);
                        $(".daily-bot-det").text("您的购物车已有" + data["resultData"]["totalProductNum"] + "件商品")
                    } else {
                        $("#tp").css({
                            "display": "none"
                        });
                        $(".daily-bot-det").text("您的购物车空空如也")
                    }
                    $(".daily-shopcar-messege p:last-of-type").text("");
                    var _height = parseInt($(".car-inr").height())
                      , _h = 0;
                    var _timer = setInterval(function() {
                        _h += 4;
                        $(".shopCar").css({
                            "display": "block"
                        }).height((_h));
                        if (_h > _height + 90) {
                            clearInterval(_timer);
                            _h = 0
                        }
                    }, 5);
                    if (Number(data["resultData"]["totalProductPrice"]) >= 25) {
                        $(".car-bot-btn").text("去结算").css({
                            "background": "#EF8200",
                            "color": "#f7f7f7"
                        }).attr({
                            "ck": 1
                        });
                        storageGoods()
                    } else {
                        $(".car-bot-btn").text("差￥" + Number(25 - Number(data["resultData"]["totalProductPrice"])).toFixed(2) + "结算").css({
                            "background": "#dedede",
                            "color": "#323232",
                            "fontSize": "1.3rem"
                        }).attr({
                            "ck": 0
                        })
                    }
                    changeCar();
                    clearCar();
                    $(".daily-shopcar").addClass("hid");
                    if ($(".shopCar").attr("class").indexOf("hid")) {
                        hidSth(_obj);
                        hidCar(_obj)
                    }
                } else {
                    var _div = $("<div>").addClass("hid_cont");
                    var _alrt = $("<div>").addClass("alrt").css({
                        "lineHeight": "40px"
                    }).text("您的购物车为空");
                    _div.appendTo($("body"));
                    _alrt.appendTo($("body"));
                    setTimeout(function() {
                        _div.remove();
                        _alrt.remove()
                    }, 900)
                }
            }
        })
    } else {
        messageAlert("您还没登录");
        setTimeout(function() {
            window.location.href = "login.html"
        }, 120)
    }
}
function changeCar() {
    $(".car-item-add").each(function(i) {
        touch.on($(".car-item-add").eq(i), "tap", function() {
            if ($(".car-item-add").eq(i).attr("cl") > 0) {
                sAjax("shoppingcar/updateQuantityByPrimaryKey", "get", {
                    quantity: parseInt($(".car-item-num").eq(i).text()) + 1,
                    id: $(".car-item-num").eq(i).attr("id"),
                    productId: $(".car-item-num").eq(i).attr("productId"),
                    pCode: $(".car-item-num").eq(i).attr("pCode"),
                    mallCode: sessionStorage.getItem("mall")
                }, function(data) {
                    if (data["status"] == "ok") {
                        $(".car-item-num").eq(i).text(parseInt($(".car-item-num").eq(i).text()) + 1);
                        sAjax("shoppingcar/selectCarAllProduct", "get", {
                            mallCode: sessionStorage.getItem("mall"),
                            userId: localStorage.getItem("userId")
                        }, function(data1) {
                            if (data1["status"] == "ok") {
                                for (var j = 0, _lenj = data1["resultData"]["shoppingCarList"].length; j < _lenj; j += 1) {
                                    if ($(".car-item-num").eq(i).attr("productid") == data1["resultData"]["shoppingCarList"][j]["productId"]) {
                                        $(".car-item-prc").eq(i).text(data1["resultData"]["shoppingCarList"][j]["itemPrice"])
                                    }
                                }
                                $(".daily-bot-price").text("￥ " + Number(data1["resultData"]["totalProductPrice"]).toFixed(2));
                                $(".daily-bot-det").text("您的购物车已有" + data1["resultData"]["totalProductNum"] + "件商品");
                                $("#tp").text(data1["resultData"]["totalProductNum"]);
                                if (Number(data1["resultData"]["totalProductPrice"]) >= 25) {
                                    $(".car-bot-btn").text("去结算").css({
                                        "background": "#EF8200",
                                        "color": "#f7f7f7",
                                        "fontSize": "1.4rem"
                                    }).attr({
                                        "ck": 1
                                    });
                                    storageGoods()
                                } else {
                                    $(".car-bot-btn").text("差￥" + Number(25 - Number(data1["resultData"]["totalProductPrice"])).toFixed(2) + "结算").css({
                                        "background": "#dedede",
                                        "color": "#323232",
                                        "fontSize": "1.3rem"
                                    }).attr({
                                        "ck": 0
                                    })
                                }
                            }
                        })
                    } else {
                        messageAlert(data["message"])
                    }
                })
            }
        })
    });
    $(".car-item-min").each(function(i) {
        touch.on($(".car-item-min").eq(i), "tap", function() {
            if ($(".car-item-min").eq(i).attr("cl") > 0) {
                if (parseInt($(".car-item-num").eq(i).text()) > 1) {
                    sAjax("shoppingcar/updateQuantityByPrimaryKey", "get", {
                        quantity: parseInt($(".car-item-num").eq(i).text()) - 1,
                        id: $(".car-item-num").eq(i).attr("id"),
                        productId: $(".car-item-num").eq(i).attr("productId"),
                        pCode: $(".car-item-num").eq(i).attr("pCode"),
                        mallCode: sessionStorage.getItem("mall")
                    }, function(data) {
                        if (data["status"] == "ok") {
                            $(".car-item-num").eq(i).text(parseInt($(".car-item-num").eq(i).text()) - 1);
                            sAjax("shoppingcar/selectCarAllProduct", "get", {
                                mallCode: sessionStorage.getItem("mall"),
                                userId: localStorage.getItem("userId")
                            }, function(data1) {
                                if (data1["status"] == "ok") {
                                    for (var j = 0, _lenj = data1["resultData"]["shoppingCarList"].length; j < _lenj; j += 1) {
                                        if ($(".car-item-num").eq(i).attr("productid") == data1["resultData"]["shoppingCarList"][j]["productId"]) {
                                            $(".car-item-prc").eq(i).text(Number(data1["resultData"]["shoppingCarList"][j]["itemPrice"]).toFixed(2))
                                        }
                                    }
                                    $("#tp").text(data1["resultData"]["totalProductNum"]);
                                    $(".daily-bot-det").text("您的购物车已有" + data1["resultData"]["totalProductNum"] + "件商品");
                                    $(".daily-bot-price").text(Number(data1["resultData"]["totalProductPrice"]).toFixed(2));
                                    if (Number(data1["resultData"]["totalProductPrice"]) > 25) {
                                        $(".car-bot-btn").text("去结算").css({
                                            "background": "#EF8200",
                                            "color": "#f7f7f7",
                                            "fontSize": "1.4rem"
                                        }).attr({
                                            "ck": 1
                                        });
                                        storageGoods()
                                    } else {
                                        $(".car-bot-btn").text("差￥" + Number(25 - Number(data1["resultData"]["totalProductPrice"])).toFixed(2) + "结算").css({
                                            "background": "#dedede",
                                            "color": "#323232",
                                            "fontSize": "1.3rem"
                                        }).attr({
                                            "ck": 0
                                        })
                                    }
                                }
                            })
                        }
                    })
                } else {
                    var _ids = JSON.stringify([$(".car-item-num").eq(i).attr("id")]);
                    sAjax("shoppingcar/deleteByPrimaryKey", "get", {
                        ids: _ids
                    }, function(data) {
                        if (data["status"] == "ok") {
                            $(".car-item-min").eq(i).parent().parent().parents(".car_goods").hide();
                            var _h = 36;
                            if ($(".car-item-min").eq(i).parent().parent(".car-item").prev(".ex_goods_link")) {
                                _h += $(".car-item-min").eq(i).parent().parent(".car-item").siblings(".ex_goods_link").height()
                            }
                            if ($(".car-item-min").eq(i).parent().parent(".car-item").siblings(".ex_goods")) {
                                $(".car-item-min").eq(i).parent().parent(".car-item").siblings(".ex_goods").each(function(j) {
                                    _h += $(".car-item-min").eq(i).parent().parent(".car-item").siblings(".ex_goods").eq(j).height()
                                })
                            }
                            if ($(".car_list").height() > 310) {
                                $(".car_list").height($(".car_list").height() - _h)
                            } else {
                                $(".car_list").height($(".car_list").height() - _h);
                                $(".car-inr").height($(".car-inr").height() - _h);
                                $(".shopCar").height($(".shopCar").height() - _h)
                            }
                            sAjax("shoppingcar/selectCarAllProduct", "get", {
                                mallCode: sessionStorage.getItem("mall"),
                                userId: localStorage.getItem("userId")
                            }, function(data1) {
                                if (data1["status"] == "ok") {
                                    $(".daily-bot-price").text(Number(data1["resultData"]["totalProductPrice"]).toFixed(2));
                                    if (data1["resultData"]["totalProductNum"] > 0) {
                                        $(".daily-bot-det").text("您的购物车已有" + data1["resultData"]["totalProductNum"] + "件商品");
                                        $("#tp").text(data1["resultData"]["totalProductNum"]);
                                        $("#tip").text(data1["resultData"]["totalProductNum"])
                                    } else {
                                        $("#tp").css({
                                            "display": "none"
                                        });
                                        $("#tip").css({
                                            "display": "none"
                                        });
                                        $(".shopCar").css({
                                            "display": "none"
                                        });
                                        $(".car_cont").addClass("hid");
                                        setTimeout(function() {
                                            $(".car_conts").addClass("hid")
                                        }, 8)
                                    }
                                    getCarNum();
                                    if (Number(data1["resultData"]["totalProductPrice"]) >= 25) {
                                        $(".car-bot-btn").text("去结算").css({
                                            "background": "#EF8200",
                                            "color": "#f7f7f7"
                                        }).attr({
                                            "ck": 1
                                        });
                                        storageGoods()
                                    } else {
                                        $(".car-bot-btn").text("差￥" + Number(25 - Number(data1["resultData"]["totalProductPrice"])).toFixed(2) + "结算").css({
                                            "background": "#dedede",
                                            "color": "#323232"
                                        }).attr({
                                            "ck": 0
                                        })
                                    }
                                    $(".daily-shopcar").removeClass("hid")
                                }
                            })
                        }
                    })
                }
            }
        })
    })
}
function clearCar() {
    touch.on($(".clear-car"), "tap", function() {
        $("<div>").addClass("zIn").addClass("car_zIn").css({
            "zIndex": "" + 4,
            "background": "#000",
            "opacity": "0.2"
        }).appendTo($("body"));
        $("<div>").addClass("posit").addClass("car_posit").addClass("carClear").appendTo($("body"));
        $(".carClear").html("<div class='carClear_top'>您确定清空购物车吗？</div><div class='carClear_bot'><span class='carClear_sure'>确定</span><span class='carClear_cancel'>取消</span></div>");
        touch.on($(".carClear_sure"), "tap", function() {
            var _arr = [];
            $(".car-item-num").each(function(i) {
                if (i > 0) {
                    _arr.push($(".car-item-num").eq(i).attr("id"))
                }
            });
            sAjax("shoppingcar/deleteByPrimaryKey", "get", {
                ids: JSON.stringify(_arr)
            }, function(data) {
                if (data["status"] == "ok") {
                    $(".car_zIn").remove();
                    $(".car_posit").remove();
                    $(".car_list").html($(".car_goods").eq(0));
                    $(".car-inr").height(0);
                    $(".shopCar").height(0);
                    $(".shopCar").css({
                        "display": "none"
                    });
                    $(".car_cont").addClass("hid");
                    if (sessionStorage.getItem("tar")) {
                        sessionStorage.removeItem("tar")
                    }
                    $(".daily-shopcar-warn").css({
                        "background": "#959595"
                    });
                    setTimeout(function() {
                        $(".car_conts").addClass("hid")
                    }, 300);
                    $(".daily-shopcar").removeClass("hid");
                    getCarNum()
                }
            })
        });
        touch.on($(".carClear_cancel"), "tap", function() {
            $(".car_zIn").remove();
            $(".car_posit").remove()
        })
    })
}
function getCarNum() {
    var _add_mall = "";
    if (sessionStorage.getItem("mall")) {
        _add_mall = sessionStorage.getItem("mall")
    } else if (/mall=\d+/.test(window.location.href)) {
        _add_mall = window.location.href.match(/mall=\d+/)[0].replace("mall=", "");
        sessionStorage.setItem("mall", _add_mall)
    }
    if (localStorage.getItem("userId")) {
        sAjax("shoppingcar/selectCarAllProduct", "get", {
            mallCode: _add_mall,
            userId: localStorage.getItem("userId")
        }, function(data) {
            if (data["status"] == "ok") {
                $("#tip").text(data["resultData"]["totalProductNum"]);
                if (data["resultData"]["totalProductNum"] > 0) {
                    $("#tip").css({
                        "display": "block"
                    });
                    $(".daily-shopcar-messege").find(".daily-shopcar-num").text("您的购物车已有" + data["resultData"]["totalProductNum"] + "商品")
                } else {
                    $("#tip").css({
                        "display": "none"
                    });
                    $(".daily-shopcar-messege").find(".daily-shopcar-num").text("您的购物车空空如也")
                }
                if (Number(data["resultData"]["totalProductPrice"]) >= 25) {
                    $(".daily-shopcar-warn p").text("去结算").css({
                        "background": "#ef8200",
                        "color": "#f7f7f7"
                    });
                    $(".daily-shopcar-warn p").attr({
                        "ck": 1
                    });
                    touch.on($(".daily-shopcar-warn"), "tap", function() {
                        var str = "";
                        for (var i = 0, _len = data["resultData"]["shoppingCarList"].length; i < _len; i += 1) {
                            str += data["resultData"]["shoppingCarList"][i]["pCode"] + "&"
                        }
                        localStorageArr(str)
                    })
                } else {
                    $(".daily-shopcar-warn p").css({
                        "background": "#dedede",
                        "color": "#323232",
                        "fontSize": "1.3rem"
                    }).text("差￥" + Number(25 - Number(data["resultData"]["totalProductPrice"])).toFixed(2) + "结算");
                    $(".daily-shopcar-warn").attr({
                        "ck": 0
                    })
                }
            }
        })
    } else {
        $(".daily-shopcar-warn p").text("￥25.00起送")
    }
}
function hidShopCar(_obj) {
    touch.on($(".car_back"), "tap", function() {
        $(".car_list").height(0);
        var _h = $(".shopCar").height();
        var _timer = setInterval(function() {
            _h -= 4;
            $(".shopCar").height((_h));
            if (_h < 0) {
                clearInterval(_timer);
                _h = 0;
                $(".shopCar").height((_h));
                $(".shopCar").css({
                    "display": "none"
                })
            }
        }, 5);
        $(".car_cont").addClass("hid");
        setTimeout(function() {
            $(".car_conts").addClass("hid")
        }, 300);
        if (_obj) {
            _obj.removeClass("hid");
            getCarNum()
        }
    })
}
function hidCar(_obj) {
    touch.on($(".daily-bot-btn"), "tap", function() {
        $(".car_list").height(0);
        var _h = $(".shopCar").height();
        var _timer = setInterval(function() {
            _h -= 4;
            $(".shopCar").height((_h));
            if (_h < 0) {
                clearInterval(_timer);
                _h = 0;
                $(".shopCar").height((_h));
                $(".shopCar").css({
                    "display": "none"
                })
            }
        }, 5);
        $(".car_cont").addClass("hid");
        setTimeout(function() {
            $(".car_conts").addClass("hid")
        }, 300);
        if (_obj) {
            _obj.removeClass("hid");
            getCarNum()
        }
    })
}
function showCarList(_obj) {
    touch.on($(".daily-shopcar-img"), "tap", function() {
        checkCar(_obj)
    });
    hidShopCar(_obj);
    hidCar(_obj)
}
function localStorageArr(_str) {
    sessionStorage.setItem("arr", _str);
    postListInfor(JSON.stringify(getLocalStorageArr("&")))
}
function postListInfor(_obj) {
    if (sessionStorage.getItem("arr")) {
        var _tar = sessionStorage.getItem("tar");
        sAjax("order/submitOrder", "get", {
            userId: localStorage.getItem("userId"),
            mallCode: sessionStorage.getItem("mall"),
            pCodeArray: _obj
        }, function(data) {
            if (data["status"] == "ok") {
                removeInfor();
                window.location.href = "postList.html"
            } else {
                messageAlert(data["message"])
            }
        })
    }
}
function storageGoods() {
    touch.on($(".car-bot-btn"), "tap", function() {
        if ($(".car-bot-btn").attr("ck") > 0) {
            var _str = ""
              , _json = {};
            $(".car-item-num").each(function(i) {
                if (i > 0) {
                    if ($(".car-item-num").eq(i).attr("itemstatus") == 0) {
                        _str += "" + $(this).attr("pCode") + "&"
                    }
                    if ($(".car_goods").eq(i).attr("actype") == 4) {
                        var _arr = [];
                        for (var j = 0, _lenj = $(".car_goods").eq(i).find(".ex_goods").size(); j < _lenj; j += 1) {
                            _arr.push($(".car_goods").eq(i).find(".ex_goods").attr("trid"))
                        }
                        _json["" + $(".car_goods").eq(i).attr("jk")] = _arr
                    }
                }
            });
            localStorageArr(_str);
            if (!(_json)) {
                sessionStorage.setItem("tar", _json)
            }
        }
    })
}
function getLocalStorageArr(_code) {
    if (sessionStorage.getItem("arr")) {
        var _goods = sessionStorage.getItem("arr");
        var _goods_rep = _goods.split(_code);
        var _goods_arr = [];
        for (var j = 0; j < _goods_rep.length; j += 1) {
            if (_goods_rep[j]) {
                _goods_arr.push(_goods_rep[j])
            }
        }
        return _goods_arr
    }
}
function addShopingCar(_obj, _obj1, _str, _img, _fc) {
    var _timer = 10
      , _flg = 0;
    var _obj = document.getElementsByTagName("img");
    for (var _o = 0, _leno = _obj.length; _o < _leno; _o += 1) {
        if (_obj[_o].getAttribute("itemStatus") == 0) {
            if (_obj[_o].className.indexOf("add_car") > -1) {
                _obj[_o].onclick = function(e) {
                    if (localStorage.getItem("userId")) {
                        var _this = this;
                        if (_timer > 0 && (Number(e.timeStamp) - Number(_timer) > 100)) {
                            if (localStorage.getItem("userId")) {
                                if (sessionStorage.getItem("mall") || /mall=\d+/.test(window.location.href)) {
                                    var _add_mall = "";
                                    if (sessionStorage.getItem("mall")) {
                                        _add_mall = sessionStorage.getItem("mall")
                                    } else if (/mall=\d+/.test(window.location.href)) {
                                        _add_mall = window.location.href.match(/mall=\d+/)[0].replace("mall=", "")
                                    }
                                    sAjax("shoppingcar/insertSelective", "get", {
                                        productId: Number(this.getAttribute("productId")),
                                        mallCode: _add_mall,
                                        pCode: this.getAttribute("pCode"),
                                        userId: localStorage.getItem("userId"),
                                        quantity: 1,
                                        pSendType: parseInt(this.getAttribute("pSendType"))
                                    }, function(data) {
                                        if (data["status"] == "error") {
                                            messageAlert(data["message"])
                                        } else {
                                            if (_fc) {
                                                _fc()
                                            }
                                            sAjax("shoppingcar/selectCarAllProduct", "get", {
                                                mallCode: _add_mall,
                                                userId: localStorage.getItem("userId")
                                            }, function(data1) {
                                                if (data1["status"] == "ok") {
                                                    $("#tip").css({
                                                        "display": "block"
                                                    }).text("");
                                                    var _crt = $("<img />");
                                                    _crt.addClass("lei").appendTo($("body"));
                                                    var _pic = _this.parentNode.parentNode.getElementsByTagName("img")[0];
                                                    _top = Number(_this.getBoundingClientRect().top + 2);
                                                    _left = Number(_this.getBoundingClientRect().left - 70);
                                                    _crt.attr({
                                                        "src": _pic.src
                                                    });
                                                    _crt.css({
                                                        "display": "block",
                                                        "left": _left + "px",
                                                        "top": _top + "px"
                                                    });
                                                    var _bot = Number($(_str).offset().left);
                                                    var _btl = Number($(_str).offset().top) + 10;
                                                    jQuery(function($) {
                                                        $('.lei').fly({
                                                            start: {
                                                                left: _left,
                                                                top: _top
                                                            },
                                                            end: {
                                                                left: _bot - 20 + 0.22 * $("body").width(),
                                                                top: _btl,
                                                                width: 10,
                                                                height: 10
                                                            },
                                                            autoPlay: true,
                                                            speed: 1.1,
                                                            vertex_Rtop: 100,
                                                            onEnd: function() {
                                                                _crt.remove();
                                                                if (data1["resultData"]["totalProductNum"] > 0) {
                                                                    $("#tip").text(data1["resultData"]["totalProductNum"])
                                                                }
                                                                if (_obj1) {
                                                                    _obj1.text("￥" + Number(data1["resultData"]["totalProductPrice"]).toFixed(2))
                                                                }
                                                            }
                                                        })
                                                    });
                                                    if (data1["resultData"]["totalProductNum"] > 0) {
                                                        $("#tip").css({
                                                            "display": "block"
                                                        });
                                                        $(".daily-shopcar-messege").find(".daily-shopcar-num").text("您的购物车已有" + data1["resultData"]["totalProductNum"] + "商品")
                                                    } else {
                                                        $("#tip").css({
                                                            "display": "none"
                                                        });
                                                        $(".daily-shopcar-messege").find(".daily-shopcar-num").text("您的购物车空空如也")
                                                    }
                                                    if (Number(data1["resultData"]["totalProductPrice"]) >= 25) {
                                                        $(".daily-shopcar-warn p").text("去结算").css({
                                                            "background": "#ef8200",
                                                            "color": "#f7f7f7"
                                                        });
                                                        $(".daily-shopcar-warn").attr({
                                                            "ck": 1
                                                        });
                                                        touch.on($(".daily-shopcar-warn"), "tap", function() {
                                                            var str = "";
                                                            for (var i = 0, _len = data1["resultData"]["shoppingCarList"].length; i < _len; i += 1) {
                                                                str += Number(data1["resultData"]["shoppingCarList"][i]["pCode"]) + "&"
                                                            }
                                                            localStorageArr(str)
                                                        })
                                                    } else {
                                                        $(".daily-shopcar-warn p").text("差￥" + Number(25 - Number(data1["resultData"]["totalProductPrice"])).toFixed(2) + "结算").css({
                                                            "background": "#dedede",
                                                            "color": "#323232"
                                                        });
                                                        $(".daily-shopcar-warn").attr({
                                                            "ck": 0
                                                        })
                                                    }
                                                }
                                            })
                                        }
                                    })
                                }
                            }
                            _timer = 0,
                            _flg = e.timeStamp;
                            return _timer
                        }
                        e.timeStamp > 0 ? _timer = e.timeStamp : _timer = _flg;
                        return _timer
                    } else {
                        messageAlert("您还没有登陆");
                        setTimeout(function() {
                            window.location.href = "login.html"
                        }, 120)
                    }
                }
            }
        }
    }
}